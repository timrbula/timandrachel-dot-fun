---
import BaseLayout from "../../components/astro/BaseLayout.astro";
import Marquee from "../../components/react/Marquee";
import BlinkingText from "../../components/react/BlinkingText";
import RainbowDivider from "../../components/react/RainbowDivider";
import GeoButton from "../../components/react/GeoButton";
import RSVPEditForm from "../../components/react/RSVPEditForm";

// Get token from URL query params
const url = new URL(Astro.request.url);
const token = url.searchParams.get("token");
---

<BaseLayout
  title="Edit RSVP - Rachel & Tim üíå"
  description="Edit your wedding RSVP"
>
  <!-- Top Marquee -->
  <Marquee client:load speed={15}>
    ‚úèÔ∏è Edit Your RSVP ‚úèÔ∏è Make changes to your response
  </Marquee>

  <div class="container">
    <!-- Page Header -->
    <section class="page-header text-center">
      <h1 class="text-3d">
        <BlinkingText client:load speed="slow">‚úèÔ∏è</BlinkingText>
        Edit Your RSVP
        <BlinkingText client:load speed="slow">‚úèÔ∏è</BlinkingText>
      </h1>
      <p class="subtitle">Update your wedding response</p>
    </section>

    <RainbowDivider client:load variant="animated" />

    <!-- Loading State -->
    <section class="loading-section" id="loading-section">
      <div class="loading-box geo-box-neon text-center">
        <div class="loading-spinner">‚è≥</div>
        <p class="loading-text">Verifying your link...</p>
      </div>
    </section>

    <!-- Error State -->
    <section class="error-section" id="error-section" style="display: none;">
      <div class="error-box geo-box text-center">
        <h2 class="text-neon">
          <BlinkingText client:load>‚ö†Ô∏è</BlinkingText>
          Invalid or Expired Link
          <BlinkingText client:load>‚ö†Ô∏è</BlinkingText>
        </h2>
        <p class="error-text" id="error-text">
          This link is invalid or has expired.
        </p>
        <p>Please request a new link to edit your RSVP.</p>
        <div class="error-actions">
          <GeoButton client:load variant="primary" href="/rsvp">
            üîô Back to RSVP
          </GeoButton>
        </div>
      </div>
    </section>

    <!-- Edit Form Container -->
    <section class="form-section" id="form-section" style="display: none;">
      <div class="form-container geo-box-raised">
        <h2 class="text-center text-3d">
          <BlinkingText client:load>‚ú®</BlinkingText>
          Update Your Response
          <BlinkingText client:load>‚ú®</BlinkingText>
        </h2>

        <!-- Form will be injected here by React component -->
        <RSVPEditForm client:load token={token || ""} />
      </div>
    </section>

    <RainbowDivider client:load variant="solid" />

    <!-- Help Section -->
    <section class="help-section">
      <div class="help-box geo-box-neon text-center">
        <h2 class="text-3d">
          <BlinkingText client:load>üí¨</BlinkingText>
          Need Help?
          <BlinkingText client:load>üí¨</BlinkingText>
        </h2>
        <p>
          If you're having trouble editing your RSVP, please reach out to us:
        </p>
        <p>
          üìß Email: <a href="mailto:hello@rachelandtim.fun" class="text-cyan"
            >hello@rachelandtim.fun</a
          >
        </p>
      </div>
    </section>
  </div>

  <!-- Bottom Marquee -->
  <Marquee client:load speed={20} direction="right">
    üíï Thanks for updating your RSVP! üéâ
  </Marquee>
</BaseLayout>

<script define:vars={{ token }}>
  // Verify token on page load
  async function verifyToken() {
    const loadingSection = document.getElementById("loading-section");
    const errorSection = document.getElementById("error-section");
    const formSection = document.getElementById("form-section");
    const errorText = document.getElementById("error-text");

    if (!token) {
      loadingSection.style.display = "none";
      errorSection.style.display = "block";
      errorText.textContent = "No authentication token provided.";
      return;
    }

    try {
      const response = await fetch(
        `/api/rsvp-verify-token?token=${encodeURIComponent(token)}`
      );
      const data = await response.json();

      if (response.ok && data.valid) {
        // Token is valid, show form
        loadingSection.style.display = "none";
        formSection.style.display = "block";
      } else {
        // Token is invalid
        loadingSection.style.display = "none";
        errorSection.style.display = "block";
        errorText.textContent =
          data.error || "This link is invalid or has expired.";
      }
    } catch (error) {
      console.error("Error verifying token:", error);
      loadingSection.style.display = "none";
      errorSection.style.display = "block";
      errorText.textContent =
        "An error occurred while verifying your link. Please try again.";
    }
  }

  // Run verification when page loads
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", verifyToken);
  } else {
    verifyToken();
  }
</script>

<style>
  /* Page Header */
  .page-header {
    padding: 2rem 0;
  }

  .page-header h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
  }

  .subtitle {
    font-size: 1.3rem;
    max-width: 700px;
    margin: 0 auto;
  }

  /* Loading Section */
  .loading-section {
    margin: 3rem 0;
  }

  .loading-box {
    max-width: 600px;
    margin: 0 auto;
    padding: 3rem;
  }

  .loading-spinner {
    font-size: 4rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .loading-text {
    font-size: 1.3rem;
    margin-top: 1rem;
  }

  /* Error Section */
  .error-section {
    margin: 3rem 0;
  }

  .error-box {
    max-width: 700px;
    margin: 0 auto;
    padding: 3rem 2rem;
    background: rgba(255, 0, 0, 0.1);
    border: 3px solid var(--color-red);
  }

  .error-text {
    font-size: 1.3rem;
    margin: 1rem 0;
  }

  .error-actions {
    margin-top: 2rem;
  }

  /* Form Section */
  .form-section {
    margin: 3rem 0;
  }

  .form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2.5rem;
  }

  .form-container h2 {
    margin-bottom: 2rem;
  }

  /* Help Section */
  .help-section {
    margin: 3rem 0;
  }

  .help-box {
    max-width: 700px;
    margin: 0 auto;
    padding: 2.5rem;
  }

  .help-box p {
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  /* Links */
  a {
    text-decoration: underline;
  }

  a:hover {
    opacity: 0.8;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 2.5rem;
    }

    .subtitle {
      font-size: 1.1rem;
    }
  }
</style>
